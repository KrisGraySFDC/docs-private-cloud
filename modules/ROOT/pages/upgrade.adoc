= Upgrade to Anypoint Platform Private Cloud, Version 2.0
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

This topic provides information about upgrading Anypoint Platform Private Cloud Edition to the most recent version. This version supports the following migration paths:

[%header%autowidth.spread]
|===
| Base Version | Intermediate Versions | Target Version | Comments
| 1.7.x | N/A | 2.0 | Direct upgrade is supported
| 1.6.x | 1.7.1 | 2.0 | Must upgrade to version 1.7.1
| 1.5.x | 1.6.1, 1.7.1 | 2.0 | Must upgrade to 1.6.1, then 1.7.1 before upgrading to 2.0.
|===

The following table summarizes the new features included in Anypoint Platform Private Cloud Edition version 2.0.

[%header%autowidth.spread]
|===
| Component | Feature Description
| Exchange | Store all integration assets in one place in Exchange, such as best practices, integration patterns, API fragments, API specifications, examples, templates, and connectors.
| Exchange |	Enrich portal content using the Visual editor and Markdown editor.
| Exchange |	Upload Open API specifications (Swagger) in Exchange, which automatically converts to RAML for use across the Anypoint toolset.
| Exchange |	Upload WSDLs (SOAP APIs) in Exchange.
| Exchange |	Consume and reuse from Studio & Design Center.	
| Exchange |	Share an asset with users from other business groups.
| Exchange |	Auto-generate a Mule 4.0 Design Center connector (using REST Connect) for any valid API specification for use within Design Center.
| Exchange |	View a list of dependencies (API Fragments) for any API specification.
| Exchange |	Version any asset published to Exchange.
| Exchange |	View Dependency Snippet for connectors for use in Maven, Gradle, SBT, and Ivy.
| Exchange |	Publish examples and templates using Studio 6.3 and later.
| Exchange |	API Portals are now part of Exchange.
| Exchange |	Create public portals for any APIs in Anypoint Exchange.
| Exchange |	Automatically generate rich documentation for RAML and OAS specifications.
| Exchange |	Perform interactive API use case validation through API Notebook.
| Exchange |	Use a new mocking service for testing API calls without API implementation.
| Exchange |	Register clients and request access for APIs managed by Anypoint Platform.
| Exchange |	Automatically index API instances and endpoints via Exchange.
| Exchange |	Share APIs externally using Exchange portal.
| Exchange |	Customize and brand features of Exchange portal.
| Exchange |	Leverage HTML support for content inserted in a Markdown editor (limitations apply).
| Exchange |	Save a search for organizations that provides consistent search navigation to all business group users.
| Exchange |	Utilize personalized saved searches to save frequently used searches.
| Exchange |	Copy images into the Exchange visual editor, which eliminates the need to serve images from outside Exchange.
| Exchange |	Managed categories allow Exchange administrators and Organization owners to create categories and group Exchange assets.
| Exchange |	Exchange contributors can now organize assets into different groups to improve asset browsing and discovery.
| Exchange |	Custom fields allow Exchange administrators and contributors to extend existing asset attributes through the API.
| Exchange |	Reorder pages on asset detail page.
| API Manager |	Environment support provided on API Manager.
| API Manager |	Support provided for Mule 4 APIs.
| API Manager |	Create multiple instances of an API.
| API Manager |	Integrate with Exchange 2.0.
| API Manager |	Promote APIs between different environments.
| API Manager |	Environment-based granular permissions are available for API Manager.
| API Manager |	Resource level policy support, which was formerly restricted to RAML-based APIs, is extended to any HTTP API.
| API Manager	
a| Mule 4-related changes to API Manager:

* Classloader isolation between the application, the runtime, the connectors, and the policies.
* Changes to packaging, size, and scope of a policy.
* All policies are non-blocking.
* All policies can be ordered except CORS, which is executed first.
| API Manager	
a| Two new platform APIs for managing APIs:

* API Manager API v1.0 to manage API.
* API Manager proxy API v1.0 to manage the deployment of API proxies through API Manager.
| Runtime Manager |	Improved error description on alert creation.	
|===

See xref:1.6@upgrade.adoc[About Migrating Anypoint Platform Private Cloud Edition] for information on upgrading to version 1.6.1. See xref:1.7@upgrade.adoc[About Migrating Anypoint Platform Private Cloud Edition] for information on upgrading to version 1.7.1.

[WARNING]
During the migration process, there will be some downtime as each node is updated.

== Application Upgrades

The procedures in this topic describe how to migrate Anypoint Platform and the Anypoint Private Cloud edition infrastructure. You must also upgrade your applications to work with the new version of Anypoint Platform. Contact your customer success representative for more information.

== Prerequisites

Before migrating, ensure that you have performed and met the following prerequisites:

* Perform a backup of your system as described in xref:backup-and-disaster-recovery.adoc[About Backup and Recovery]. If you are upgrading from an older version that requires multiple intermediate upgrades you must backup each intermediate version before proceding to the next.

* Anypoint Private Cloud, version 2.0 requires that you have an NFS server installed and configured. Ensure that this is installed before beginning the upgrade. See xref:prereq-hardware.adoc[Private Cloud Edition Hardware Requirements]

* Ensure that your environment meets all of the system and network requirements described in xref:prereq-workflow.adoc[Workflow: Install and Verify Prerequisites for Physical Servers].

* Ensure that the necessary kernel modules are enabled as described in xref:prereq-software.adoc#kernel-modules[Software Requirements for Anypoint Private Cloud]. 

* Enable TCP ports `53`, `3011`, `3012` intra-node to allow communication with the database cluster.

* Ensure you have permission to run the `sudo` command on the node where you launch the migration tool.

* Ensure the `kubectl` command is available in the node where you are performing the migration. To verify that `kubectl` is installed, run the following:
+
----
$ sudo gravity enter
$ kubectl
----

== Procedure

. Obtain a link to the installer from your customer success representative.

. Use `ssh` to login to the master node of your cluster.
+
In a 3-node environment, all nodes are master nodes. To find the master nodes in a 6-node environment, run the following command:
+
----
kubectl get node --show-labels | grep gravitational.io/k8s-role=master
----
+
By performing these procedures from the master node, the upgrade scripts are able to update the entire platform.

. Uncompress the application archive.
+
----
tar -xvf anypoint-2.0.0-installer.tar.gz
----

. Navigate to the `anypoint-2.0.0` directory, then run the upload script.
+
----
cd anypoint-2.0.0
sudo ./upgrade
----
+
This command updates the platform to the current version and restarts each pod in the cluster.
+
----
$ sudo ./upgrade
----
+
This command produces output similar to the following:
+
----
-> initializing upload
-> uploading update package
importing anypoint:2.0.0
Thu Aug 23 09:36:30 UTC	Synchronizing application with Docker registry x.x.x.xxx:5000
Thu Aug 23 09:44:27 UTC	Synchronizing application with Docker registry x.x.x.xxx:5000
Thu Aug 23 09:51:29 UTC	Synchronizing application with Docker registry x.x.x.xxx:5000
Thu Aug 23 09:58:23 UTC	Application has been uploaded
updating anypoint from 1.7.1 to 2.0.0-xxxxxxxxxxxx
update operation (d077277f-3c69-4336-82bf-bd8b428ae202) has been started
the cluster is updating in background
----
+
Depending on your network configuration, this command may take a while to complete. Wait until the command finishes before proceeding to the next step.

. Verify that the migration was successful by performing one of the following:
+
* Run the following command from the node where you performed the upgrade:
+
----
$ sudo gravity enter
$ kubectl get pods
----
+
* Login to the Ops Center at the following URL:
+
----
https://{platform-host}:9500
----
+
[WARNING]
Before accessing Anypoint Platform, ensure that you configure your NSF server s described in the following step. Failure to configure NFS before accessing the platform may result in data loss.

. Configure Anypoint Private Cloud to use your NFS server.
+
After upgrading Anypoing Private Cloud, you configure it to use the required NFS server.
+
.. From Anypoint Platform, select *Access Management*.
.. Click *NFS Settings*.
.. Enter the domain name of your NFS server.
.. Enter the path to your NFS server.
.. Click *Save*.
.. Click *Test NFS Server* to test that your NFS server is configured correctly.
